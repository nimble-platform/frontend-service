<p class="pb-3 nimble-title">Publish Product</p>
<p>All published products must belong to at least one category, which will describe the product and help customers find your offering.</p>
<div class="form-group row d-flex">
    <div class="col-12 inline">
        <form #categorySearch="ngForm" (ngSubmit)="onSearchCategory()" novalidate>
        <!-- TODO: All Categories Search Goes Here-->
            <div class="input-group">
                <div ngbDropdown class="d-inline-block input-group-prepend">
                    <button class="btn btn-outline-dark" type="button" id="allCategories" ngbDropdownToggle>
                        All Categories
                    </button>
                    <!-- TODO: Requires a service change -->
                    <div ngbDropdownMenu aria-labelledby="allCategories">
                        <a class="dropdown-item">All Categories</a>
                    </div>
                </div>
        <!-- End TODO: All Categories Search -->
                <input type="text" class="form-control" name="inputCtrl" [(ngModel)]="categoryKeyword" placeholder="Search Category..."/>
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary" [disabled]="!categorySearch.form.valid">
                        <i class="fa fa-search"></i> Search Categories
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mt-4 d-flex">
    <div class="col-7 pr-0 pb-0">
        <!-- Tree view deactivated -->
        <div *ngIf="!treeView" class="border" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">
            <table class="table table-hover mb-0">
                <thead class="thead-light fixed">
                    <th scope="col" style="color: #000;">Classification</th>
                    <th scope="col" style="color: #000;">Name</th>
                    <th scope="col" colspan="2" class="p-0"><button class="btn btn-secondary mb-1" (click)="toggleTreeView()">Browse</button></th>
                </thead>
                <tbody>
                    <tr *ngIf="callback && !submitted && (!categories || categories.length == 0)">
                        <td colspan="3">No results found.</td>
                    </tr>
                    <tr *ngFor="let category of categories"
                        (click)="getCategoryDetails(category)"
                        [ngClass]="{'table-secondary': selectedCategory && category.code == selectedCategory.code}">
                        <td class="py-2 px-3 font-weight-light">{{category.taxonomyId}}</td>
                        <td class="py-2 px-3">{{category.preferredName}}</td>
                        <td></td>
                        <td class="d-flex">
                            <span class="fa fa-fw mr-1 icon-secondary" [ngClass]="{'fa-sitemap': category.taxonomyId == 'eClass'}" aria-hidden="true" (click)="getCategoryTree(category)"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Tree view activated -->
        <div *ngIf="treeView" class="border" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">
            <div class="fixed" style="background-color: #e9ecef;">
                <div class="row border">
                    <div class="col-8 pr-0">
                        <div class="thead-light-equivalent">
                            <p class="mb-0" style="padding: 0.75rem;">All Categories</p>
                        </div>
                    </div>
                    <div class="col-4 pl-0">
                        <div class="thead-light-equivalent">
                            <button *ngIf="categories" class="btn btn-secondary float-right my-1 mr-1" (click)="toggleTreeView()">Back to Search Results</button>
                        </div>
                    </div>
                </div>
            </div>
            <div *ngIf="rootCategories">
                <div class="d-flex flex-column" style="height: 400px">
                    <div *ngIf="showLogisticsCategories" class="mb-3">
                        <h4 class="p-2">Logistics Categories</h4>
                        <category-tree [category]="eClassLogisticsCategory" [border]="false" [parentCategories]="parentCategories" (detailsEvent)="getCategoryDetails($event)" [selectedCategory]="selectedCategory" [selectedCategories]="selectedCategories"></category-tree>
                    </div>
                    <div *ngIf="showProductCategories">
                        <h4 class="p-2">Product Categories</h4>
                        <div *ngFor="let rootCategory of rootCategories">
                            <category-tree [category]="rootCategory" [parentCategories]="parentCategories" (detailsEvent)="getCategoryDetails($event)" [selectedCategory]="selectedCategory" [selectedCategories]="selectedCategories"></category-tree>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-5 pl-0">
        <div class="border" [ngClass]="{'disabled-section': !selectedCategoryWithDetails && (callback || !submitted || error_detc)}" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">
            <div class="d-flex flex-row fixed p-2" [ngClass]="{'fixed-header': selectedCategoryWithDetails}">
                <h4 class="font-weight-bold" *ngIf="!selectedCategoryWithDetails">Details</h4>
                <h4 class="font-weight-bold mr-auto" *ngIf="selectedCategoryWithDetails">Details for {{selectedCategoryWithDetails["preferredName"]}}</h4>
                <div *ngIf="selectedCategoryWithDetails">
                    <button *ngIf="findCategoryInArray(selectedCategories, selectedCategoryWithDetails) === -1" class="btn btn-primary align-self-start" (click)="selectCategory(selectedCategoryWithDetails)">Add Category</button>
                    <button *ngIf="findCategoryInArray(selectedCategories, selectedCategoryWithDetails) > -1" class="btn btn-danger align-self-start" (click)="removeCategory(selectedCategoryWithDetails)">Remove Category</button>
                </div>
            </div>
            <p *ngIf="!selectedCategoryWithDetails" [hidden]="!(callback || !submitted || error_detc)" class="align-self-center p-2 mt-4">Click on a category to see its details.</p>
            <div [hidden]="callback || !submitted || error_detc" class="space-right p-2">
                <img class="space-before" src="assets/form_loader.gif"/>
            </div>     
            <div *ngIf="selectedCategoryWithDetails" class="p-2 mt-2">
                <div *ngFor="let propName of propertyNames" class="my-1">
                    <text-input *ngIf="selectedCategoryWithDetails[propName]" [visible]="selectedCategoryWithDetails[propName]" presentationMode="view" [label]="propName" labelClass="col-12 text-capitalize" labelMainClass="mb-0" valueClass="col-12" valueTextClass="mb-1 pl-3" [text]="getCategoryProperty(propName)"></text-input>
                </div>
                <div class="row">
                    <div class="col-12 mb-0" *ngIf="selectedCategoryWithDetails.properties.length > 0">
                        <label>
                            <strong>Properties: </strong>
                        </label>
                    </div>
                </div>
                <div *ngFor="let prop of selectedCategoryWithDetails.properties;let i = index;let l = last">
                    <div class="row">
                        <div class="col-8">
                            <label>
                                <p class="text-capitalize pl-3 mb-1">
                                    {{prop.preferredName}}
                                    <span *ngIf="prop.definition" class="label label-default" title="{{prop.definition}}">
                                        &#9432;
                                    </span>
                                </p>
                            </label>
                        </div>
                        <div class="col-4">
                            <label>
                                <p class="mb-1 font-weight-light">
                                    {{getPropertyType(prop)}}
                                </p>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<hr>
<div class="form-group row">
    <div *ngIf="this.appComponent.checkRoles('catalogue')" class="col-9 d-flex align-items-center">
        <p class="mt-1 mb-0 mr-3 flex-shrink-0">Selected Categories: </p>
        <p class="mt-1 mb-0 mr-3 flex-shrink-0" *ngIf="categoryService.selectedCategories.length === 0">None. Please add a category above to proceed.</p>
        <div class="w-100 h-100 align-self-start">
            <div class="d-flex flex-wrap">
                <div *ngFor="let selectedCategory of categoryService.selectedCategories"
                class="bordered d-flex align-items-center mx-1 my-1" title="{{selectedCategory.taxonomyId}}">
                    <small class="p-0">{{selectedCategory.preferredName}}</small>
                    <i class="fa fa-times-circle pl-1 text-red" placement="right" (click)="removeCategory(selectedCategory)"></i>
                </div>
            </div>
        </div>
    </div>
    <div *ngIf="!this.appComponent.checkRoles('catalogue')" class="col-9 d-flex align-items-center">
        <p class="mt-1 mb-0 mr-3">You do not have permission to publish any products to your company catalogue.</p>
    </div>
    <div class="col-3 align-self-center">
        <button class="btn btn-primary w-100 inline" [disabled]="categoryService.selectedCategories.length === 0 || navigating ||  !this.appComponent.checkRoles('catalogue')" (click)="navigateToPublishingPage()">Continue With Selected Categories</button>
        <div [hidden]="!navigating" class="space-right">
            <img class="space-before" src="assets/form_loader.gif"/>
        </div>    
    </div>
</div>